{"version":3,"file":"relay.min.js","sources":["../../../../node_modules/.pnpm/uuid@11.1.0/node_modules/uuid/dist/esm-browser/regex.js","../../../../node_modules/.pnpm/uuid@11.1.0/node_modules/uuid/dist/esm-browser/stringify.js","../../../../node_modules/.pnpm/uuid@11.1.0/node_modules/uuid/dist/esm-browser/rng.js","../../../../node_modules/.pnpm/uuid@11.1.0/node_modules/uuid/dist/esm-browser/native.js","../../../../node_modules/.pnpm/uuid@11.1.0/node_modules/uuid/dist/esm-browser/v4.js","../../../src/constants.ts","../../../src/client-id/client-id.ts","../../../../node_modules/.pnpm/uuid@11.1.0/node_modules/uuid/dist/esm-browser/validate.js","../../../src/version.ts","../../../src/event/meta/meta.ts","../../../src/utils/url-shortener.ts","../../../src/listener/listener.ts","../../../src/config/config.ts","../../../src/environment/browser/storage/cookie.ts","../../../src/environment/browser/browser.ts","../../../../node_modules/.pnpm/@coveo+explorer-messenger@0.4.1/node_modules/@coveo/explorer-messenger/dist/messenger.js","../../../src/environment/browser/storage/storage.ts","../../../src/environment/manager/manager.ts","../../../src/environment/null/null.ts","../../../src/environment/storage.ts","../../../src/environment/browser/storage/availability.ts","../../../src/relay.ts","../../../src/event/relay-event.ts","../../../src/emit/emit.ts"],"sourcesContent":["export default /^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;\n","import validate from './validate.js';\nconst byteToHex = [];\nfor (let i = 0; i < 256; ++i) {\n    byteToHex.push((i + 0x100).toString(16).slice(1));\n}\nexport function unsafeStringify(arr, offset = 0) {\n    return (byteToHex[arr[offset + 0]] +\n        byteToHex[arr[offset + 1]] +\n        byteToHex[arr[offset + 2]] +\n        byteToHex[arr[offset + 3]] +\n        '-' +\n        byteToHex[arr[offset + 4]] +\n        byteToHex[arr[offset + 5]] +\n        '-' +\n        byteToHex[arr[offset + 6]] +\n        byteToHex[arr[offset + 7]] +\n        '-' +\n        byteToHex[arr[offset + 8]] +\n        byteToHex[arr[offset + 9]] +\n        '-' +\n        byteToHex[arr[offset + 10]] +\n        byteToHex[arr[offset + 11]] +\n        byteToHex[arr[offset + 12]] +\n        byteToHex[arr[offset + 13]] +\n        byteToHex[arr[offset + 14]] +\n        byteToHex[arr[offset + 15]]).toLowerCase();\n}\nfunction stringify(arr, offset = 0) {\n    const uuid = unsafeStringify(arr, offset);\n    if (!validate(uuid)) {\n        throw TypeError('Stringified UUID is invalid');\n    }\n    return uuid;\n}\nexport default stringify;\n","let getRandomValues;\nconst rnds8 = new Uint8Array(16);\nexport default function rng() {\n    if (!getRandomValues) {\n        if (typeof crypto === 'undefined' || !crypto.getRandomValues) {\n            throw new Error('crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported');\n        }\n        getRandomValues = crypto.getRandomValues.bind(crypto);\n    }\n    return getRandomValues(rnds8);\n}\n","const randomUUID = typeof crypto !== 'undefined' && crypto.randomUUID && crypto.randomUUID.bind(crypto);\nexport default { randomUUID };\n","import native from './native.js';\nimport rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\nfunction v4(options, buf, offset) {\n    if (native.randomUUID && !buf && !options) {\n        return native.randomUUID();\n    }\n    options = options || {};\n    const rnds = options.random ?? options.rng?.() ?? rng();\n    if (rnds.length < 16) {\n        throw new Error('Random bytes length must be >= 16');\n    }\n    rnds[6] = (rnds[6] & 0x0f) | 0x40;\n    rnds[8] = (rnds[8] & 0x3f) | 0x80;\n    if (buf) {\n        offset = offset || 0;\n        if (offset < 0 || offset + 16 > buf.length) {\n            throw new RangeError(`UUID byte range ${offset}:${offset + 15} is out of buffer bounds`);\n        }\n        for (let i = 0; i < 16; ++i) {\n            buf[offset + i] = rnds[i];\n        }\n        return buf;\n    }\n    return unsafeStringify(rnds);\n}\nexport default v4;\n","export const clientIdKey = \"visitorId\";\n","import { validate } from \"uuid\";\nimport { EnvironmentManager } from \"../environment/manager/manager.js\";\nimport { clientIdKey } from \"../constants.js\";\n\nexport interface ClientIdManager {\n  getClientId: () => string;\n}\n\nexport function createClientIdManager(\n  environmentManager: EnvironmentManager,\n): ClientIdManager {\n  return {\n    getClientId: () => {\n      const environment = environmentManager.get();\n      const storage = environment.storage;\n\n      const existingClientId = storage.getItem(clientIdKey);\n      const clientId =\n        existingClientId && validate(existingClientId)\n          ? existingClientId\n          : environment.generateUUID();\n      storage.setItem(clientIdKey, clientId);\n      return clientId;\n    },\n  };\n}\n","import REGEX from './regex.js';\nfunction validate(uuid) {\n    return typeof uuid === 'string' && REGEX.test(uuid);\n}\nexport default validate;\n","export const version = \"process.env.VERSION\";\n","import type { ClientIdManager } from \"../../client-id/client-id.js\";\nimport type { Environment } from \"../../environment/environment.js\";\nimport type { RelayConfig } from \"../../config/config.js\";\nimport { version } from \"../../version.js\";\nimport { truncateUrl } from \"../../utils/url-shortener.js\";\n\n/**\n * The `EventConfig` object provides additional information for the configuration associated with the event.\n */\nexport interface EventConfig {\n  /**\n   * The unique identifier of a web property. See [What's a tracking ID?](https://docs.coveo.com/en/n8tg0567/).\n   */\n  trackingId: string | null;\n}\n\n/**\n * The `Meta` object provides a structured representation of metadata associated with an emitted event.\n * This object is auto-populated by Relay.\n */\nexport interface Meta {\n  /**\n   * Event's type that was emitted.\n   */\n  type: string;\n\n  /**\n   * Configuration associated with the event.\n   */\n  config: EventConfig;\n\n  /**\n   * Timestamp when the event was emitted.\n   */\n  ts: number;\n\n  /**\n   * Names and versions of the client side libraries which built and emitted this event.\n   */\n  source: string[];\n\n  /**\n   * Persistent unique identifier of a device.\n   */\n  clientId: string;\n\n  /**\n   * Browser Navigator's [user agent](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/userAgent) property if set.\n   */\n  userAgent: string | null;\n\n  /**\n   * Browser Document's [referrer](https://developer.mozilla.org/en-US/docs/Web/API/Document/referrer) property if set.\n   */\n  referrer: string | null;\n\n  /**\n   * Browser Location's [href](https://developer.mozilla.org/en-US/docs/Web/API/Location/href) property if set.\n   */\n  location: string | null;\n}\n\nfunction getEventConfig(config: RelayConfig): EventConfig {\n  const { trackingId } = config;\n  return { trackingId };\n}\n\nfunction getSource(config: RelayConfig): string[] {\n  return (config.source || []).concat([`relay@${version}`]);\n}\n\nexport function createMeta(\n  type: string,\n  config: RelayConfig,\n  environment: Environment,\n  clientIdManager: ClientIdManager,\n): Readonly<Meta> {\n  const { getReferrer, getLocation, getUserAgent } = environment;\n  const eventConfig = getEventConfig(config);\n  const clientId = clientIdManager.getClientId();\n\n  return Object.freeze<Meta>({\n    type,\n    config: eventConfig,\n    ts: Date.now(),\n    source: getSource(config),\n    clientId,\n    userAgent: getUserAgent(),\n    referrer: truncate(getReferrer()),\n    location: truncate(getLocation()),\n  });\n}\n\nfunction truncate(url: string | null) {\n  const limit = 1024;\n  return url !== null ? truncateUrl(url, limit) : null;\n}\n","/**\n * Can be used to both check if the first bit is set (for any utf-8 multibyte part),\n * and to detect \"following bytes\" (which start with `10xx_xxxx`)\n */\nconst UTF8_HIGH_BIT = 0b1000_0000;\n/** Header for a 2-byte code point: `110x_xxxx`. Can also be used as bit-mask to check for \"following bytes\". */\nconst UTF8_HEADER_2 = 0b1100_0000;\n/** Header for a 3-byte code point: `1110_xxxx`. Can also be used as bit-mask to check for \"header 2\". */\nconst UTF8_HEADER_3 = 0b1110_0000;\n/** Header for a 4-byte code point: `1111_0xxx`. Can also be used as bit-mask to check for \"header 3\". */\nconst UTF8_HEADER_4 = 0b1111_0000;\n/** Bit-mask for \"header 4\".  */\nconst UTF8_HEADER_4_MASK = 0b1111_1000;\n\nfunction utf8ByteCountFromFirstByte(firstByte: number): number {\n  if ((firstByte & UTF8_HEADER_4_MASK) === UTF8_HEADER_4) {\n    return 4;\n  }\n  if ((firstByte & UTF8_HEADER_4) === UTF8_HEADER_3) {\n    return 3;\n  }\n  if ((firstByte & UTF8_HEADER_3) === UTF8_HEADER_2) {\n    return 2;\n  }\n  return 1;\n}\n\n/**\n * Truncate a URL to an arbitrary length, taking care to not break inside a percent escape or UTF-8 multibyte sequence.\n *\n * @param input The input to truncate to the specified limit.\n * @param limit The limit to apply; if negative, no truncation is applied.\n * @returns The URL, possibly truncated to a length near limit (at most 11 characters less than limit).\n */\nexport function truncateUrl(input: string, limit: number): string {\n  if (limit < 0 || input.length <= limit) {\n    return input;\n  }\n  // A valid escape sequence is a percent followed by 2 hexadecimal characters; check if we split one up.\n  let end: number = input.indexOf(\"%\", limit - 2);\n  if (end < 0 || end > limit) {\n    end = limit;\n  } else {\n    limit = end;\n  }\n  // Check that truncating at end won't break up an UTF-8 multibyte sequence half-way,\n  // by peeking backwards to find the first byte of an UTF-8 sequence (if present).\n  while (end > 2 && input.charAt(end - 3) == \"%\") {\n    const peekByte = Number.parseInt(input.substring(end - 2, end), 16);\n    // Note: if parsing fails, NaN gets coerced to 0 by the bitwise and.\n    if ((peekByte & UTF8_HIGH_BIT) != UTF8_HIGH_BIT) {\n      break;\n    }\n    end -= 3;\n    // Check if we reached the first byte by checking it is not a \"follow byte\": 10xx_xxxx.\n    if ((peekByte & UTF8_HEADER_2) != UTF8_HIGH_BIT) {\n      // If the full code point is there, keep it.\n      if (limit - end >= utf8ByteCountFromFirstByte(peekByte) * 3) {\n        end = limit;\n      }\n      // Otherwise, end is already set at the correct point to truncate at (the start of the multibyte sequence).\n      break;\n    }\n  }\n  return input.substring(0, end);\n}\n","import type { RelayEvent } from \"../event/relay-event.js\";\n\nconst ANY_EVENT_TYPE = \"*\";\n\n/**\n * Callback to perform an action when a specified event is emitted.\n * @typedef {function} EventCallback\n * @param {RelayEvent} event - the Relay event payload that triggered the callback.\n * @returns {void}\n */\nexport type EventCallback = (event: RelayEvent) => void;\n\ninterface Listener {\n  type: string;\n  callback: EventCallback;\n}\n\nexport interface ListenerManager {\n  add: (listener: Listener) => () => void;\n  call: (event: RelayEvent) => void;\n  remove: (type: string, callback?: EventCallback) => void;\n}\n\nexport function createListenerManager(): ListenerManager {\n  const listeners: Listener[] = [];\n\n  function getListenerIndex({ type, callback }: Listener): number {\n    return listeners.findIndex(\n      (listener) => listener.type === type && listener.callback === callback,\n    );\n  }\n\n  function isMatchesType(listener: Listener, type: string): boolean {\n    return listener.type === \"*\" || type === listener.type;\n  }\n\n  function add(listener: Listener): () => void {\n    if (getListenerIndex(listener) < 0) {\n      listeners.push(listener);\n    }\n    return () => remove(listener.type, listener.callback);\n  }\n\n  function call(event: RelayEvent) {\n    listeners.forEach((listener) => {\n      if (isMatchesType(listener, event.meta.type)) {\n        try {\n          listener.callback(event);\n        } catch (e) {\n          console.error(e);\n        }\n      }\n    });\n  }\n\n  function removeMultiple(type: string) {\n    if (type === ANY_EVENT_TYPE) {\n      listeners.length = 0;\n    } else {\n      for (let i = listeners.length - 1; i >= 0; i--) {\n        if (listeners[i].type === type) {\n          listeners.splice(i, 1);\n        }\n      }\n    }\n  }\n\n  function removeOne(listener: Listener) {\n    const index = getListenerIndex(listener);\n    if (index >= 0) {\n      listeners.splice(index, 1);\n    }\n  }\n\n  function remove(type: string, callback?: EventCallback) {\n    if (callback) {\n      removeOne({ type, callback });\n    } else {\n      removeMultiple(type);\n    }\n  }\n\n  return {\n    add,\n    call,\n    remove,\n  };\n}\n","import { CustomEnvironment } from \"../environment/custom/custom.js\";\n\n/**\n * The `RelayConfig` object defines the configuration options for initializing a Relay instance.\n */\nexport interface RelayConfig {\n  /**\n   * Endpoint defined to communicate with the Event API.\n   */\n  url: string;\n\n  /**\n   * Token to authorize the access to the Event API endpoint.\n   */\n  token: string;\n\n  /**\n   * The unique identifier of a web property. See [What's a tracking ID?](https://docs.coveo.com/en/n8tg0567/).\n   * Can be null, in that case events are assigned to an internal default tracking ID.\n   */\n  trackingId: string | null;\n\n  /**\n   * Defines the library mode. The available modes are `emit` and `disabled`.\n   * `emit` sends analytics events to Coveo to be stored.\n   * `disabled` prevents the emission of events and does not trigger callbacks.\n   * @default emit\n   */\n  mode?: \"emit\" | \"disabled\";\n\n  /**\n   * Optionally allows a Relay integration to specify the name(s) of software package(s) relay is\n   * being called from. These names will be transmitted with each event, along with Relay's own\n   * version. The recommendation is to specify them using a 'softwarename@softwareversion' string.\n   */\n  source?: string[];\n\n  /**\n   * Optionally allows you to specify a custom environment for Relay, allowing integrations to override the default behavior.\n   * This is useful when Relay runs in unsupported or specialized contexts that require custom handling.\n   */\n  environment?: CustomEnvironment;\n}\n\nexport interface ConfigManager {\n  get: () => Readonly<RelayConfig>;\n  update: (updatedConfig: Partial<RelayConfig>) => void;\n}\n\nfunction pick({\n  url,\n  token,\n  trackingId,\n  ...rest\n}: RelayConfig): Readonly<RelayConfig> {\n  return Object.freeze({\n    url,\n    token,\n    trackingId,\n    ...(!!rest.mode && { mode: rest.mode }),\n    ...(!!rest.source && { source: rest.source }),\n    ...(!!rest.environment && { environment: rest.environment }),\n  });\n}\n\nexport function createConfigManager(\n  initialConfig: RelayConfig,\n): Readonly<ConfigManager> {\n  let _config: Readonly<RelayConfig> = pick(initialConfig);\n\n  return {\n    get: () => _config,\n    update: (updatedConfig: Partial<RelayConfig>) => {\n      _config = pick({ ..._config, ...updatedConfig });\n    },\n  };\n}\n","export interface CookieManager {\n  getItem: (key: string) => string | null;\n  removeItem: (key: string) => void;\n  setItem: (key: string, data: string, expire: number) => void;\n}\n\nexport const cookieManager: CookieManager = createCookieManager();\n\nfunction createCookieManager(): CookieManager {\n  const prefix = \"coveo_\";\n  const getDomain = (host: string) => {\n    const parts = host.split(\".\").slice(-2);\n    return parts.length == 2 ? parts.join(\".\") : \"\";\n  };\n\n  return {\n    getItem(key: string): string | null {\n      const cookiePrefix = `${prefix}${key}=`;\n      const cookieArray = document.cookie.split(\";\");\n      for (const cookie of cookieArray) {\n        const prettifyCookie = cookie.replace(/^\\s+/, \"\");\n        if (prettifyCookie.lastIndexOf(cookiePrefix, 0) === 0) {\n          return prettifyCookie.substring(\n            cookiePrefix.length,\n            prettifyCookie.length,\n          );\n        }\n      }\n      return null;\n    },\n    setItem(key: string, data: string, expire: number): void {\n      const domain = getDomain(window.location.hostname);\n      const expireSection = `;expires=${new Date(\n        new Date().getTime() + expire,\n      ).toUTCString()}`;\n      const domainSection = domain ? `;domain=${domain}` : \"\";\n      document.cookie = `${prefix}${key}=${data}${expireSection}${domainSection};path=/;SameSite=Lax`;\n    },\n\n    removeItem(key: string): void {\n      this.setItem(key, \"\", -1);\n    },\n  };\n}\n","import { createExplorerMessenger } from \"@coveo/explorer-messenger\";\nimport type { Environment } from \"../environment.js\";\nimport { createBrowserStorage } from \"./storage/storage.js\";\nimport type { RelayEvent } from \"../../event/relay-event.js\";\nimport { v4 as uuidv4 } from \"uuid\";\n\nfunction getReferrer(): string | null {\n  const referrer = document.referrer;\n\n  return referrer === \"\" ? null : referrer;\n}\n\nexport function buildBrowserEnvironment(): Environment {\n  return {\n    runtime: \"browser\",\n    send: (url: string, token: string, event: RelayEvent) => {\n      const response = navigator.sendBeacon(\n        `${url}?access_token=${token}`,\n        new Blob([JSON.stringify([event])], {\n          type: \"application/json\",\n        }),\n      );\n\n      const messenger = createExplorerMessenger();\n      messenger.sendMessage({ kind: \"EVENT_PROTOCOL\", event, url, token });\n\n      if (!response) {\n        throw new Error(\n          `Failed to send the event(s) because the payload size exceeded the maximum allowed size (32 KB). Please contact support if the problem persists.`,\n        );\n      }\n    },\n    getReferrer: () => getReferrer(),\n    getLocation: () => window.location.href,\n    getUserAgent: () => navigator.userAgent,\n    generateUUID: () => uuidv4(),\n    storage: createBrowserStorage(),\n  };\n}\n","function createExplorerMessenger() {\n  const isBrowser = typeof window !== \"undefined\";\n  return {\n    sendMessage(message) {\n      isBrowser && window.postMessage(message, \"*\");\n    }\n  };\n}\nexport {\n  createExplorerMessenger\n};\n","import type { Storage } from \"../../storage.js\";\nimport { cookieManager } from \"./cookie.js\";\n\nexport function createBrowserStorage(): Storage {\n  return {\n    getItem(key: string): string | null {\n      return cookieManager.getItem(key) || localStorage.getItem(key);\n    },\n\n    removeItem(key: string): void {\n      cookieManager.removeItem(key);\n      localStorage.removeItem(key);\n    },\n\n    setItem(key: string, data: string): void {\n      const oneYear = 31556952000;\n      localStorage.setItem(key, data);\n      cookieManager.setItem(key, data, oneYear);\n    },\n  };\n}\n","import type { ConfigManager } from \"../../config/config.js\";\nimport { buildBrowserEnvironment } from \"../browser/browser.js\";\nimport { localStorageAvailable } from \"../browser/storage/availability.js\";\nimport type { Environment } from \"../environment.js\";\nimport { buildNullEnvironment } from \"../null/null.js\";\n\nexport interface EnvironmentManager {\n  get: () => Readonly<Environment>;\n}\n\nfunction buildEnvironment(configManager: ConfigManager): Environment {\n  const active = configManager.get().mode !== \"disabled\";\n\n  const environmentFromConfig = configManager.get().environment;\n  const nullEnvironment = buildNullEnvironment();\n\n  if (active && environmentFromConfig) {\n    return {\n      storage: nullEnvironment.storage,\n      ...environmentFromConfig,\n      runtime: \"custom\",\n    };\n  }\n\n  if (active && isBrowser() && localStorageAvailable()) {\n    return buildBrowserEnvironment();\n  }\n\n  return nullEnvironment;\n}\n\nfunction isBrowser() {\n  try {\n    return typeof window === \"object\";\n  } catch {\n    return false;\n  }\n}\n\nexport function createEnvironmentManager(\n  configManager: ConfigManager,\n): Readonly<EnvironmentManager> {\n  return {\n    get: () => Object.freeze(buildEnvironment(configManager)),\n  };\n}\n","import type { Environment } from \"../environment.js\";\nimport { createNullStorage } from \"../storage.js\";\n\nexport function buildNullEnvironment(): Environment {\n  return {\n    runtime: \"null\",\n    send: () => undefined,\n    getReferrer: () => null,\n    getLocation: () => null,\n    getUserAgent: () => null,\n    generateUUID: () => \"\",\n    storage: createNullStorage(),\n  };\n}\n","/**\n * Interface that defines a minimal key-value storage mechanism used by Relay.\n */\nexport interface Storage {\n  /**\n   * Retrieves the stored string value associated with the specified key.\n   * Returns `null` if the key does not exist or has no value.\n   * @param {string} key - Key corresponding to the desired value.\n   * @returns {string|null}\n   */\n  getItem: (key: string) => string | null;\n\n  /**\n   * Removes the value associated with the specified key from storage.\n   * If the key does not exist, no action is taken.\n   * @param {string} key - Key to remove.\n   * @returns {void}\n   */\n  removeItem: (key: string) => void;\n\n  /**\n   * Stores a string value under the specified key. Overwrites any existing value.\n   * @param {string} key - Key under which the value should be stored.\n   * @param {string} data - String data to store.\n   * @returns {void}\n   */\n  setItem: (key: string, data: string) => void;\n}\n\nexport function createNullStorage(): Storage {\n  return {\n    getItem(): string | null {\n      return null;\n    },\n    removeItem(): void {\n      return;\n    },\n    setItem(): void {\n      return;\n    },\n  };\n}\n","// From: https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API#feature-detecting_localstorage\nexport function localStorageAvailable() {\n  try {\n    const x = \"__storage_test__\";\n    localStorage.setItem(x, x);\n    localStorage.removeItem(x);\n    return true;\n  } catch (e) {\n    return (\n      e instanceof DOMException &&\n      e.name === \"QuotaExceededError\" &&\n      // acknowledge QuotaExceededError only if there's something already stored\n      localStorage &&\n      localStorage.length !== 0\n    );\n  }\n}\n","import { emit } from \"./emit/emit.js\";\nimport { createClientIdManager } from \"./client-id/client-id.js\";\nimport { createRelayEvent, type RelayEvent } from \"./event/relay-event.js\";\nimport { version } from \"./version.js\";\nimport { createMeta, type Meta, type EventConfig } from \"./event/meta/meta.js\";\nimport {\n  createListenerManager,\n  type EventCallback,\n} from \"./listener/listener.js\";\nimport { createConfigManager, type RelayConfig } from \"./config/config.js\";\nimport type { Environment } from \"./environment/environment.js\";\nimport type { CustomEnvironment } from \"./environment/custom/custom.js\";\nimport type { Storage } from \"./environment/storage.js\";\nimport { createEnvironmentManager } from \"./environment/manager/manager.js\";\nimport type { RelayPayload } from \"./relay-payload.js\";\nexport { buildBrowserEnvironment } from \"./environment/browser/browser.js\";\nexport { clientIdKey } from \"./constants.js\";\n\n/**\n * Function that detaches an event callback.\n * @typedef {function} Off\n * @returns {void}\n */\nexport type Off = () => void;\n\n/**\n * Relay instance.\n * This object provides a comprehensive set of variables and methods for interacting with the Event API.\n */\ninterface Relay {\n  /**\n   * Sends an event to the Event API.\n   * @param {string} type - event's type to be emitted.\n   * @param {Record<string,any>} payload - payload to include within the event.\n   * @returns {void}\n   */\n  emit: (type: string, payload: Record<string, any>) => void;\n\n  /**\n   * Gets the client-side generated meta object.\n   * @param {string} type - event's type that will be included in the meta object.\n   * @returns {Meta}\n   */\n  getMeta: (type: string) => Meta;\n\n  /**\n   * Attaches an event callback to either all event types or a specific one.\n   * The callback set will be called when an event with the specified type is emitted.\n   * Itâ€™s not possible to modify the payload of the event sent to Coveo using this listener.\n   * Setting type as \"*\" will trigger the callback for all event types.\n   * Returns the \"off\" function to detach the event callback.\n   * @param {string} type - event's type.\n   * @param {EventCallback} callback - callback that should be called when the event is emitted.\n   * @returns {Off}\n   */\n  on: (type: string, callback: EventCallback) => Off;\n\n  /**\n   * Detach callback(s) from events.\n   * If only the \"type\" parameter is set, all callbacks for the specified type will be removed.\n   * @param {string} type - event's type.\n   * @param {EventCallback} callback - callback that should be removed.\n   * @returns {void}\n   */\n  off: (type: string, callback?: EventCallback) => void;\n\n  /**\n   * Updates Relay's configuration after its initialization.\n   * @param {Partial<RelayConfig>} config - configuration that should be updated.\n   * @returns {void}\n   */\n  updateConfig: (config: Partial<RelayConfig>) => void;\n\n  /**\n   * Current version of the Relay library.\n   */\n  version: string;\n}\n\n/**\n * Initializes the Relay library object.\n * @param {RelayConfig} initialConfig\n * @returns {Relay}\n */\nexport function createRelay(initialConfig: RelayConfig): Relay {\n  const configManager = createConfigManager(initialConfig);\n  const listenerManager = createListenerManager();\n  const environmentManager = createEnvironmentManager(configManager);\n  const clientIdManager = createClientIdManager(environmentManager);\n\n  return {\n    emit: (type: string, payload: Record<string, any>) => {\n      const config = configManager.get();\n      const environment = environmentManager.get();\n\n      const event = createRelayEvent(\n        type,\n        payload,\n        config,\n        environment,\n        clientIdManager,\n      );\n\n      return emit({\n        config,\n        environment,\n        event,\n        listenerManager,\n      });\n    },\n    getMeta: (type: string) =>\n      createMeta(\n        type,\n        configManager.get(),\n        environmentManager.get(),\n        clientIdManager,\n      ),\n    on: (type: string, callback: EventCallback) =>\n      listenerManager.add({ type, callback }),\n    off: (type: string, callback?: EventCallback) =>\n      listenerManager.remove(type, callback),\n    updateConfig: (config: Partial<RelayConfig>) =>\n      configManager.update(config),\n    version,\n  };\n}\n\nexport type {\n  Relay,\n  Meta,\n  EventConfig,\n  EventCallback,\n  RelayConfig,\n  RelayPayload,\n  RelayEvent,\n  CustomEnvironment,\n  Environment,\n  Storage,\n};\n","import type { ClientIdManager } from \"../client-id/client-id.js\";\nimport type { Environment } from \"../environment/environment.js\";\nimport type { RelayPayload } from \"../relay-payload.js\";\nimport type { RelayConfig } from \"../relay.js\";\nimport { createMeta, type Meta } from \"./meta/meta.js\";\n\n/**\n * Defines the structure of a RelayEvent, extending the RelayPayload.\n */\nexport interface RelayEvent extends RelayPayload {\n  /**\n   * Read-only `meta` property of Meta type.\n   */\n  meta: Readonly<Meta>;\n}\n\nexport function createRelayEvent(\n  type: string,\n  payload: RelayPayload,\n  config: RelayConfig,\n  environment: Environment,\n  clientIdManager: ClientIdManager,\n): Readonly<RelayEvent> {\n  return {\n    ...payload,\n    meta: createMeta(type, config, environment, clientIdManager),\n  };\n}\n","import { Environment } from \"../environment/environment.js\";\nimport { ListenerManager } from \"../listener/listener.js\";\nimport { RelayEvent } from \"../event/relay-event.js\";\nimport { RelayConfig } from \"../relay.js\";\n\nexport interface EmitParams {\n  config: RelayConfig;\n  environment: Environment;\n  event: RelayEvent;\n  listenerManager: ListenerManager;\n}\n\nexport function emit({\n  config,\n  environment,\n  event,\n  listenerManager,\n}: EmitParams) {\n  const { url, token, mode } = config;\n  const isEnabled = mode !== \"disabled\";\n\n  if (isEnabled) {\n    listenerManager.call(event);\n    environment.send(url, token, event);\n  }\n}\n"],"names":["REGEX","byteToHex","i","push","toString","slice","getRandomValues","rnds8","Uint8Array","native","randomUUID","crypto","bind","v4","options","buf","offset","rnds","random","rng","Error","length","arr","toLowerCase","unsafeStringify","clientIdKey","createClientIdManager","environmentManager","getClientId","environment","get","storage","existingClientId","getItem","clientId","uuid","test","generateUUID","setItem","version","getSource","config","source","concat","createMeta","type","clientIdManager","getReferrer","getLocation","getUserAgent","eventConfig","trackingId","getEventConfig","Object","freeze","ts","Date","now","userAgent","referrer","truncate","location","url","input","limit","end","indexOf","charAt","peekByte","Number","parseInt","substring","firstByte","truncateUrl","createListenerManager","listeners","getListenerIndex","callback","findIndex","listener","remove","index","splice","removeOne","removeMultiple","add","call","event","forEach","isMatchesType","meta","e","console","error","pick","token","rest","mode","cookieManager","prefix","key","cookiePrefix","cookieArray","document","cookie","split","prettifyCookie","replace","lastIndexOf","data","expire","domain","host","parts","join","getDomain","window","hostname","expireSection","getTime","toUTCString","domainSection","removeItem","this","createCookieManager","buildBrowserEnvironment","runtime","send","response","navigator","sendBeacon","Blob","JSON","stringify","messenger","isBrowser","sendMessage","message","postMessage","createExplorerMessenger","kind","href","uuidv4","localStorage","buildEnvironment","configManager","active","environmentFromConfig","nullEnvironment","x","DOMException","name","localStorageAvailable","createRelay","initialConfig","_config","update","updatedConfig","createConfigManager","listenerManager","createEnvironmentManager","emit","payload","createRelayEvent","getMeta","on","off","updateConfig"],"mappings":"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","x_google_ignoreList":[0,1,2,3,4,7,15]}